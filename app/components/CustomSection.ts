import { mergeAttributes, Node } from "@tiptap/core";
import type { MentionInfo } from "~/types";

const CustomSection = Node.create({
  name: "section",

  group: "block",

  content: "inline*",

  defining: true,

  addOptions() {
    return {
      mentionInfos: [],
    };
  },

  parseHTML() {
    return [
      {
        tag: "section",
      },
    ];
  },

  renderHTML({ HTMLAttributes }) {
    const mentionInfos = this.options.mentionInfos;
    const sectionId = HTMLAttributes.sectionId || "";
    const section = mentionInfos.find((info: MentionInfo["data"]) => info.id === sectionId);

    return [
      "span",
      { class: "rounded-sm text-active flex items-center" },
      [
        "svg",
        {
          fill: "none",
          viewBox: "0 0 24 24",
          xmlns: "http://www.w3.org/2000/svg",
          class: "mr-1.5 mt-0.5 h-[1.06em] align-text-top inline",
          style: "fill: var(--border-white-sect)",
        },
        [
          "path",
          {
            d: "m22.1213 1.87868c-.5626-.56261-1.3257-.87868-2.1213-.87868h-2c-.5523 0-1 .44772-1 1s.4477 1 1 1h2c.2652 0 .5196.10536.7071.29289.1875.18754.2929.44189.2929.70711v16c0 .2652-.1054.5196-.2929.7071s-.4419.2929-.7071.2929h-16c-.26522 0-.51957-.1054-.70711-.2929-.18753-.1875-.29289-.4419-.29289-.7071v-10c0-.55229-.44772-1-1-1s-1 .44771-1 1v10c0 .7956.31607 1.5587.87868 2.1213s1.32567.8787 2.12132.8787h16c.7956 0 1.5587-.3161 2.1213-.8787s.8787-1.3257.8787-2.1213v-16c0-.79565-.3161-1.55871-.8787-2.12132z",
          },
        ],
        [
          "path",
          {
            "clip-rule": "evenodd",
            d: "m1.94627 6.12132c-.60589-.56261-.94627-1.32567-.94627-2.12132s.34038-1.55871.94627-2.12132 1.42765-.87868 2.2845-.87868h7.53843c.8569 0 1.6786.31607 2.2845.87868s.9463 1.32567.9463 2.12132-.3404 1.55871-.9463 2.12132-1.4276.87868-2.2845.87868h-7.53843c-.85685 0-1.67861-.31607-2.2845-.87868zm10.58443-2.82843c-.2019-.18753-.4759-.29289-.7615-.29289h-7.53843c-.28562 0-.55954.10536-.7615.29289-.20196.18754-.31542.44189-.31542.70711s.11346.51957.31542.70711c.20196.18753.47588.29289.7615.29289h7.53843c.2856 0 .5596-.10536.7615-.29289.202-.18754.3155-.44189.3155-.70711s-.1135-.51957-.3155-.70711z",
            "fill-rule": "evenodd",
          },
        ],
      ],
      [
        "span",
        {
          class: "text-middle-hard-grey flex items-center",
        },
        section?.sourceTitle || "Untitled Source",
        [
          "svg",
          {
            viewBox: "0 0 16 16",
            xmlns: "http://www.w3.org/2000/svg",
            class: "mx-1 -mb-px size-4 fill-middle-grey rotate-90",
          },
          [
            "path",
            {
              d: "m13.5844 7.52666-5.11108-5.11111c-.0634-.06069-.13816-.10827-.22-.14-.16231-.06668-.34436-.06668-.50667 0-.08183.03173-.15659.07931-.21999.14l-5.11112 5.11111c-.06216.06216-.11146.13595-.1451.21717-.03364.08121-.05096.16826-.05096.25616 0 .17754.07053.3478.19606.47334.12554.12553.2958.19606.47334.19606.17753 0 .34779-.07053.47333-.19606l3.97111-3.97778v8.61555c0 .1768.07024.3464.19526.4714.12503.125.2946.1953.47141.1953s.34638-.0703.4714-.1953c.12503-.125.19527-.2946.19527-.4714v-8.61555l3.97114 3.97778c.0619.06248.1357.11208.2169.14592.0813.03385.1684.05128.2564.05128s.1751-.01743.2564-.05128c.0812-.03384.155-.08344.2169-.14592.0625-.06198.1121-.13571.146-.21695.0338-.08124.0512-.16838.0512-.25639 0-.088-.0174-.17514-.0512-.25638-.0339-.08124-.0835-.15497-.146-.21695z",
            },
          ],
        ],
        section?.title || "Untitled Section",
      ],
    ];
  },

  addAttributes() {
    return {
      sectionId: {
        default: null,
      },
      parentId: {
        default: null,
      },
    };
  },
});

export default CustomSection;
