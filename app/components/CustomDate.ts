import { mergeAttributes, Node } from "@tiptap/core";
import dayjs from "dayjs";
import type { Card } from "~/types";

const CustomDate = Node.create({
  name: "date",
  group: "block",
  content: "inline*",

  addOptions() {
    return {
      cards: [],
    };
  },

  renderHTML({ HTMLAttributes, node }) {
    const date = node.attrs.date;
    const formattedDate = date ? dayjs(date).format("MMM D, YYYY") : "";

    const cards = this.options.cards || [];
    const id = node.attrs.date;
    const card = cards.find((c: Card) => c.id === id);
    const parentId = node.attrs.parentId;

    return [
      "span",
      mergeAttributes(HTMLAttributes, {
        "data-type": "card",
        "data-card-id": id,
        class: `card ${card ? "" : "invalid-card"}`,
        "data-parent-id": parentId,
        noreferrer: card ? undefined : "true",
      }),
      [
        "span",
        {
          class: "rounded-sm",
        },
        [
          "svg",
          {
            viewBox: "0 0 32 32",
            xmlns: "http://www.w3.org/2000/svg",
            "xmlns:xlink": "http://www.w3.org/1999/xlink",
            class:
              "mr-1.5 mb-[1px] h-[1.06em] fill-[#F3424A] align-text-top dark:fill-[#F14050] inline",
          },
          [
            "path",
            {
              d: "m16 25.3333c.2637 0 .5215-.0782.7408-.2247.2192-.1465.3901-.3547.4911-.5984.1009-.2436.1273-.5117.0758-.7703-.0514-.2587-.1784-.4963-.3649-.6827-.1864-.1865-.424-.3135-.6827-.3649-.2586-.0515-.5267-.0251-.7703.0758-.2437.101-.4519.2719-.5984.4911-.1465.2193-.2247.4771-.2247.7408 0 .3536.1405.6927.3905.9428.2501.25.5892.3905.9428.3905zm6.6667 0c.2637 0 .5215-.0782.7407-.2247.2193-.1465.3902-.3547.4911-.5984.1009-.2436.1273-.5117.0759-.7703-.0514-.2587-.1784-.4963-.3649-.6827-.1865-.1865-.424-.3135-.6827-.3649-.2586-.0515-.5267-.0251-.7704.0758-.2436.101-.4518.2719-.5983.4911-.1465.2193-.2247.4771-.2247.7408 0 .3536.1404.6927.3905.9428.25.25.5892.3905.9428.3905zm0-5.3333c.2637 0 .5215-.0782.7407-.2247.2193-.1465.3902-.3548.4911-.5984s.1273-.5117.0759-.7704c-.0514-.2586-.1784-.4962-.3649-.6827-.1865-.1864-.424-.3134-.6827-.3649-.2586-.0514-.5267-.025-.7704.0759-.2436.1009-.4518.2718-.5983.4911-.1465.2192-.2247.477-.2247.7407 0 .3537.1404.6928.3905.9429.2501.25.5892.3905.9428.3905zm-6.6667 0c.2637 0 .5215-.0782.7408-.2247.2192-.1465.3901-.3548.4911-.5984.1009-.2436.1273-.5117.0758-.7704-.0514-.2586-.1784-.4962-.3649-.6827-.1864-.1864-.424-.3134-.6827-.3649-.2586-.0514-.5267-.025-.7703.0759-.2437.1009-.4519.2718-.5984.4911-.1465.2192-.2247.477-.2247.7407 0 .3537.1405.6928.3905.9429.2501.25.5892.3905.9428.3905zm9.3334-16.00002h-1.3334v-1.33333c0-.35363-.1405-.69276-.3905-.94281-.2501-.25005-.5892-.39053-.9428-.39053s-.6928.14048-.9428.39053c-.2501.25005-.3905.58918-.3905.94281v1.33333h-10.6667v-1.33333c0-.35363-.1405-.69276-.3905-.94281-.2501-.25005-.58922-.39053-.94285-.39053-.35362 0-.69276.14048-.94281.39053-.25004.25005-.39052.58918-.39052.94281v1.33333h-1.33333c-1.06087 0-2.07828.42143-2.82843 1.17157-.75015.75015-1.17157 1.76756-1.17157 2.82843v18.66662c0 1.0609.42142 2.0783 1.17157 2.8285.75015.7501 1.76756 1.1715 2.82843 1.1715h18.66671c1.0608 0 2.0782-.4214 2.8284-1.1715.7501-.7502 1.1716-1.7676 1.1716-2.8285v-18.66662c0-1.06087-.4215-2.07828-1.1716-2.82843-.7502-.75014-1.7676-1.17157-2.8284-1.17157zm1.3333 22.66662c0 .3537-.1405.6928-.3905.9429-.2501.25-.5892.3905-.9428.3905h-18.66671c-.35362 0-.69276-.1405-.94281-.3905-.25005-.2501-.39053-.5892-.39053-.9429v-12h21.33335zm0-14.6666h-21.33335v-4.00002c0-.35362.14048-.69276.39053-.94281s.58919-.39052.94281-.39052h1.33333v1.33333c0 .35362.14048.69276.39052.94281.25005.25005.58919.39052.94281.39052.35363 0 .69275-.14047.94285-.39052.25-.25005.3905-.58919.3905-.94281v-1.33333h10.6667v1.33333c0 .35362.1404.69276.3905.94281.25.25005.5892.39052.9428.39052s.6927-.14047.9428-.39052c.25-.25005.3905-.58919.3905-.94281v-1.33333h1.3334c.3536 0 .6927.14047.9428.39052.25.25005.3905.58919.3905.94281zm-17.33335 8c.26371 0 .5215-.0782.74075-.2247.2193-.1465.3902-.3548.4911-.5984s.1273-.5117.0759-.7704c-.0515-.2586-.1785-.4962-.3649-.6827-.1865-.1864-.42408-.3134-.68273-.3649-.25864-.0514-.52673-.025-.77036.0759-.24364.1009-.45187.2718-.59838.4911-.14651.2192-.22471.477-.22471.7407 0 .3537.14048.6928.39052.9429.25005.25.58919.3905.94281.3905zm0 5.3333c.26371 0 .5215-.0782.74075-.2247.2193-.1465.3902-.3547.4911-.5984.1009-.2436.1273-.5117.0759-.7703-.0515-.2587-.1785-.4963-.3649-.6827-.1865-.1865-.42408-.3135-.68273-.3649-.25864-.0515-.52673-.0251-.77036.0758-.24364.101-.45187.2719-.59838.4911-.14651.2193-.22471.4771-.22471.7408 0 .3536.14048.6927.39052.9428.25005.25.58919.3905.94281.3905z",
            },
          ],
        ],
        [
          "span",
          {
            class:
              "border-solid border-b border-[rgba(0,0,0,0.1)] dark:border-[rgba(255,255,255,0.08)]",
          },
          formattedDate,
        ],
      ],
    ];
  },

  addAttributes() {
    return {
      date: {
        default: null,
      },
      parentId: {
        default: null,
      },
    };
  },
});

export default CustomDate;
